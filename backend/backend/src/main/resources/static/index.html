<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Management</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .post-form { margin-bottom: 20px; }
        .post-list { border: 1px solid #ccc; padding: 10px; }
        .post-item { border-bottom: 1px solid #eee; padding: 5px 0; }
        .post-item:last-child { border-bottom: none; }
        input, button { margin: 5px; padding: 5px; }
        img { max-width: 200px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Post Management</h1>

    <div id="authSection">
        <button onclick="login()">Login</button>
    </div>

    <div id="appSection" style="display: none;">
        <div class="post-form">
            <h2>Create/Update Post</h2>
            <input type="text" id="userId" placeholder="User ID">
            <input type="text" id="postId" placeholder="Post ID (for update)" disabled>
            <input type="text" id="title" placeholder="Title">
            <input type="text" id="content" placeholder="Content">
            <input type="text" id="tags" placeholder="Tags (comma-separated)">
            <input type="text" id="mediaUrls" placeholder="Media URLs (comma-separated)">
            <button onclick="savePost()">Save Post</button>
            <button onclick="clearForm()">Clear</button>
            <button onclick="logout()">Logout</button>
        </div>

        <div class="post-list" id="postList">
            <h2>Posts</h2>
            <div id="posts"></div>
        </div>
    </div>

    <script>
        const baseUrl = '/api/posts';

        // Check if user is authenticated on page load
        window.onload = async () => {
            try {
                // Make a test API call to check if the user is authenticated
                const response = await fetch(`${baseUrl}/check-auth`, { credentials: 'include' });
                if (response.ok) {
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('appSection').style.display = 'block';
                    // Optionally, fetch user info to auto-fill userId
                    fetchUserInfo();
                }
            } catch (error) {
                console.log('User not authenticated yet.');
            }
        };

        // Trigger Spring Security's OAuth 2.0 login
        function login() {
            // Redirect to Spring Security's OAuth 2.0 login endpoint
            // The registrationId (e.g., "google") must match your application.properties
            window.location.href = '/oauth2/authorization/your-registration-id'; // e.g., '/oauth2/authorization/google'
        }

        // Logout
        function logout() {
            window.location.href = '/logout'; // Spring Security's logout endpoint
        }

        // Optionally fetch user info to auto-fill userId
        async function fetchUserInfo() {
            try {
                const response = await fetch('/api/user', { credentials: 'include' });
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('userId').value = user.sub || user.id; // Adjust based on your user info endpoint
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
            }
        }

        // Load posts for a user
        async function loadPosts() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                alert('Please enter a User ID to load posts.');
                return;
            }
            try {
                const response = await fetch(`${baseUrl}/user/${userId}`, { credentials: 'include' });
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Unauthorized. Please login again.');
                        logout();
                    }
                    throw new Error('Failed to load posts');
                }
                const posts = await response.json();
                displayPosts(posts);
            } catch (error) {
                console.error('Error loading posts:', error);
            }
        }

        // Display posts in the UI
        function displayPosts(posts) {
            const postContainer = document.getElementById('posts');
            postContainer.innerHTML = '';
            posts.forEach(post => {
                const postDiv = document.createElement('div');
                postDiv.className = 'post-item';
                const mediaHtml = post.mediaUrls && post.mediaUrls.length > 0
                    ? post.mediaUrls.map(url => `<img src="${url}" alt="Media">`).join('')
                    : 'No media';
                postDiv.innerHTML = `
                    <strong>${post.title}</strong> (ID: ${post.id})<br>
                    User ID: ${post.userId}<br>
                    ${post.content}<br>
                    Tags: ${post.tags ? post.tags.join(', ') : 'None'}<br>
                    Media: ${mediaHtml}<br>
                    Likes: ${post.likes ? post.likes.length : 0}<br>
                    Created: ${new Date(post.createdAt).toLocaleString()}<br>
                    Updated: ${new Date(post.updatedAt).toLocaleString()}<br>
                    <button onclick="editPost('${post.id}')">Edit</button>
                    <button onclick="deletePost('${post.id}')">Delete</button>
                `;
                postContainer.appendChild(postDiv);
            });
        }

        // Save or update a post
        async function savePost() {
            const userId = document.getElementById('userId').value;
            const postId = document.getElementById('postId').value;
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const tags = document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const mediaUrls = document.getElementById('mediaUrls').value.split(',').map(url => url.trim()).filter(url => url);

            if (!userId || !title || !content) {
                alert('User ID, Title, and Content are required.');
                return;
            }

            const post = { userId, title, content, tags, mediaUrls };
            const method = postId ? 'PUT' : 'POST';
            const url = postId ? `${baseUrl}/${postId}` : baseUrl;

            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(post),
                    credentials: 'include'
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Unauthorized. Please login again.');
                        logout();
                    }
                    throw new Error('Failed to save post');
                }
                clearForm();
                loadPosts();
            } catch (error) {
                console.error('Error saving post:', error);
            }
        }

        // Edit a post (populate form)
        async function editPost(id) {
            try {
                const response = await fetch(`${baseUrl}/${id}`, { credentials: 'include' });
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Unauthorized. Please login again.');
                        logout();
                    }
                    throw new Error('Post not found');
                }
                const post = await response.json();
                document.getElementById('postId').value = post.id;
                document.getElementById('userId').value = post.userId;
                document.getElementById('title').value = post.title;
                document.getElementById('content').value = post.content;
                document.getElementById('tags').value = post.tags ? post.tags.join(', ') : '';
                document.getElementById('mediaUrls').value = post.mediaUrls ? post.mediaUrls.join(', ') : '';
            } catch (error) {
                console.error('Error loading post for edit:', error);
            }
        }

        // Delete a post
        async function deletePost(id) {
            if (!confirm('Are you sure you want to delete this post?')) return;
            try {
                const response = await fetch(`${baseUrl}/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Unauthorized. Please login again.');
                        logout();
                    }
                    throw new Error('Failed to delete post');
                }
                loadPosts();
            } catch (error) {
                console.error('Error deleting post:', error);
            }
        }

        // Clear the form
        function clearForm() {
            document.getElementById('postId').value = '';
            document.getElementById('userId').value = '';
            document.getElementById('title').value = '';
            document.getElementById('content').value = '';
            document.getElementById('tags').value = '';
            document.getElementById('mediaUrls').value = '';
            document.getElementById('posts').innerHTML = '';
        }

        // Load posts when user ID changes
        document.getElementById('userId').addEventListener('change', loadPosts);
    </script>
</body>
</html>