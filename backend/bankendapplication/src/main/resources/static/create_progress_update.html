<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Update Page</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        input[type="text"], textarea, select { width: 100%; padding: 8px; margin: 5px 0 15px; }
        button, input[type="submit"] { padding: 8px 15px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover, input[type="submit"]:hover { background: #0056b3; }
        #updatesContainer { margin-top: 20px; }
        .update { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; position: relative; }
        .error { color: red; }
        .success { color: green; }
        .action-buttons { position: absolute; top: 15px; right: 15px; }
        .action-buttons button { margin-left: 5px; }
        .edit-btn { background: #28a745; }
        .delete-btn { background: #dc3545; }
        .edit-form { display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Progress Update Page</h1>

    <div class="section">
        <h2>Create a New Progress Update</h2>
        <form id="updateForm">
            <label>Title:</label>
            <input type="text" id="title" name="title" required>

            <label>Description:</label>
            <textarea id="description" name="description" required></textarea>

            <label>Template Type:</label>
            <select id="templateType" name="templateType">
                <option value="COMPLETED_TUTORIAL">Completed Tutorial</option>
                <option value="LEARNED_NEW_SKILL">Learned New Skill</option>
                <option value="TIME_INVESTED">Time Invested</option>
                <option value="PRACTICE_SESSION">Practice Session</option>
                <option value="JOINED_WORKSHOP">Joined Workshop</option>
            </select>

            <label>Media URL (optional):</label>
            <input type="text" id="mediaUrl" name="mediaUrl">

            <input type="submit" value="Create Progress Update">
        </form>
        <div id="createResponse" class="response"></div>
    </div>

    <div class="section">
        <h2>Manage Progress Updates</h2>
        <div>
            <button id="getUpdatesBtn">Get All Updates</button>
            <div style="display: inline-block; margin-left: 20px;">
                <label>Search by ID:</label>
                <input type="text" id="updateIdSearch" style="width: 100px;">
                <button id="getUpdateByIdBtn">Get Update</button>
            </div>
        </div>
        <div id="updatesContainer"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:9090/api/progress-updates';
        const form = document.getElementById('updateForm');
        const getUpdatesBtn = document.getElementById('getUpdatesBtn');
        const getUpdateByIdBtn = document.getElementById('getUpdateByIdBtn');
        const updateIdSearch = document.getElementById('updateIdSearch');
        const updatesContainer = document.getElementById('updatesContainer');
        const createResponse = document.getElementById('createResponse');

        // Extract link from HATEOAS response
        function getLink(links, rel) {
            if (links && links[rel]) {
                return links[rel].href;
            }
            return null;
        }

        // Create Progress Update
        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const templateType = document.getElementById('templateType').value;
            const mediaUrl = document.getElementById('mediaUrl').value;

            const updateData = {
                userId: "123456", // Hardcoded for testing
                title,
                description,
                templateType,
                mediaUrl: mediaUrl ? mediaUrl : "",
                dateCreated: new Date().toISOString(),
                lastUpdated: new Date().toISOString(),
            };

            try {
                const res = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (res.ok) {
                    const data = await res.json();
                    createResponse.innerHTML = `<p class="success">Progress update created successfully! ID: ${data.id}</p>`;
                    form.reset();
                    fetchAllUpdates();
                } else {
                    const error = await res.json();
                    createResponse.innerHTML = `<p class="error">Failed: ${error.message || res.statusText}</p>`;
                }
            } catch (err) {
                createResponse.innerHTML = `<p class="error">Error: ${err.message}</p>`;
            }
        });

        // Get All Updates
        getUpdatesBtn.addEventListener('click', fetchAllUpdates);

        // Get Update by ID
        getUpdateByIdBtn.addEventListener('click', async () => {
            const updateId = updateIdSearch.value.trim();
            if (!updateId) {
                updatesContainer.innerHTML = `<p class="error">Please enter an update ID</p>`;
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/${updateId}`);
                if (res.ok) {
                    const update = await res.json();
                    displayUpdates([update]);
                } else {
                    const error = await res.json();
                    updatesContainer.innerHTML = `<p class="error">Error: ${error.message || 'Update not found'}</p>`;
                }
            } catch (err) {
                updatesContainer.innerHTML = `<p class="error">Error: ${err.message}</p>`;
            }
        });

        // Fetch all updates
        async function fetchAllUpdates() {
            try {
                const res = await fetch(API_BASE_URL);
                if (res.ok) {
                    const data = await res.json();
                    // HATEOAS responses include _embedded object with actual data
                    const updates = data._embedded ? data._embedded.learningProgressUpdateResponseList : data;
                    displayUpdates(updates);
                } else {
                    const error = await res.json();
                    updatesContainer.innerHTML = `<p class="error">Error: ${error.message || res.statusText}</p>`;
                }
            } catch (err) {
                updatesContainer.innerHTML = `<p class="error">Error: ${err.message}</p>`;
            }
        }

        // Display updates with edit and delete buttons
        function displayUpdates(updates) {
            if (updates.length === 0) {
                updatesContainer.innerHTML = '<p>No updates found</p>';
                return;
            }

            updatesContainer.innerHTML = updates.map(update => `
                <div class="update" id="update-${update.id}">
                    <div class="action-buttons">
                        <button class="edit-btn" data-id="${update.id}">Edit</button>
                        <button class="delete-btn" data-id="${update.id}">Delete</button>
                    </div>
                    <h3>${update.title}</h3>
                    <p><strong>ID:</strong> ${update.id}</p>
                    <p><strong>User ID:</strong> ${update.userId}</p>
                    <p>${update.description}</p>
                    <p><strong>Template Type:</strong> ${update.templateType}</p>
                    ${update.mediaUrl ? `<p><strong>Media:</strong> <a href="${update.mediaUrl}" target="_blank">${update.mediaUrl}</a></p>` : ''}
                    <p><small>Created at: ${new Date(update.dateCreated).toLocaleString()}</small></p>
                    <p><small>Last updated: ${new Date(update.lastUpdated).toLocaleString()}</small></p>
                    <div class="edit-form" id="edit-form-${update.id}">
                        <h4>Edit Progress Update</h4>
                        <form class="update-form" data-id="${update.id}">
                            <label>Title:</label>
                            <input type="text" name="title" value="${update.title}" required>

                            <label>Description:</label>
                            <textarea name="description" required>${update.description}</textarea>

                            <label>Template Type:</label>
                            <select name="templateType">
                                <option value="COMPLETED_TUTORIAL" ${update.templateType === 'COMPLETED_TUTORIAL' ? 'selected' : ''}>Completed Tutorial</option>
                                <option value="LEARNED_NEW_SKILL" ${update.templateType === 'LEARNED_NEW_SKILL' ? 'selected' : ''}>Learned New Skill</option>
                                <option value="TIME_INVESTED" ${update.templateType === 'TIME_INVESTED' ? 'selected' : ''}>Time Invested</option>
                                <option value="PRACTICE_SESSION" ${update.templateType === 'PRACTICE_SESSION' ? 'selected' : ''}>Practice Session</option>
                                <option value="JOINED_WORKSHOP" ${update.templateType === 'JOINED_WORKSHOP' ? 'selected' : ''}>Joined Workshop</option>
                            </select>

                            <label>Media URL (optional):</label>
                            <input type="text" name="mediaUrl" value="${update.mediaUrl}">

                            <input type="submit" value="Update Progress">
                            <button type="button" class="cancel-edit" data-id="${update.id}">Cancel</button>
                        </form>
                    </div>
                </div>
            `).join('');

            // Add event listeners for edit buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const updateId = e.target.getAttribute('data-id');
                    document.getElementById(`edit-form-${updateId}`).style.display = 'block';
                });
            });

            // Add event listeners for cancel buttons
            document.querySelectorAll('.cancel-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const updateId = e.target.getAttribute('data-id');
                    document.getElementById(`edit-form-${updateId}`).style.display = 'none';
                });
            });

            // Add event listeners for update forms
            document.querySelectorAll('.update-form').forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const updateId = e.target.getAttribute('data-id');
                    
                    const title = form.elements['title'].value;
                    const description = form.elements['description'].value;
                    const templateType = form.elements['templateType'].value;
                    const mediaUrl = form.elements['mediaUrl'].value;

                    const updateData = {
                        title,
                        description,
                        templateType,
                        mediaUrl: mediaUrl ? mediaUrl : "",
                        lastUpdated: new Date().toISOString(),
                    };

                    try {
                        const res = await fetch(`${API_BASE_URL}/${updateId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(updateData)
                        });

                        if (res.ok) {
                            fetchAllUpdates();
                        } else {
                            const error = await res.json();
                            alert(`Update failed: ${error.message || res.statusText}`);
                        }
                    } catch (err) {
                        alert(`Error: ${err.message}`);
                    }
                });
            });

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const updateId = e.target.getAttribute('data-id');
                    const confirmation = confirm('Are you sure you want to delete this update?');
                    if (confirmation) {
                        try {
                            const res = await fetch(`${API_BASE_URL}/${updateId}`, {
                                method: 'DELETE'
                            });

                            if (res.ok) {
                                fetchAllUpdates();
                            } else {
                                const error = await res.json();
                                alert(`Delete failed: ${error.message || res.statusText}`);
                            }
                        } catch (err) {
                            alert(`Error: ${err.message}`);
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>
