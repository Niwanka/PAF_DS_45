<!DOCTYPE html>
<html>
<head>
    <title>Post Testing via REST API</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        input[type="text"], textarea { width: 100%; padding: 8px; margin: 5px 0 15px; }
        button, input[type="submit"] { padding: 8px 15px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover, input[type="submit"]:hover { background: #0056b3; }
        #postsContainer { margin-top: 20px; }
        .post { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; position: relative; }
        .error { color: red; }
        .success { color: green; }
        .action-buttons { position: absolute; top: 15px; right: 15px; }
        .action-buttons button { margin-left: 5px; }
        .edit-btn { background: #28a745; }
        .delete-btn { background: #dc3545; }
        .edit-form { display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Post Testing Page</h1>

    <div class="section">
        <h2>Create a New Post</h2>
        <form id="postForm">
            <label>Title:</label>
            <input type="text" id="title" name="title" required>

            <label>Content:</label>
            <textarea id="content" name="content" required></textarea>

            <label>Tags (comma separated):</label>
            <input type="text" id="tags" name="tags">

            <label>Media URL (optional):</label>
            <input type="text" id="mediaUrl" name="mediaUrl">

            <input type="submit" value="Create Post">
        </form>
        <div id="createResponse" class="response"></div>
    </div>

    <div class="section">
        <h2>Manage Posts</h2>
        <div>
            <button id="getPostsBtn">Get All Posts</button>
            <div style="display: inline-block; margin-left: 20px;">
                <label>Search by ID:</label>
                <input type="text" id="postIdSearch" style="width: 100px;">
                <button id="getPostByIdBtn">Get Post</button>
            </div>
        </div>
        <div id="postsContainer"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:9090/api/posts';
        const form = document.getElementById('postForm');
        const getPostsBtn = document.getElementById('getPostsBtn');
        const getPostByIdBtn = document.getElementById('getPostByIdBtn');
        const postIdSearch = document.getElementById('postIdSearch');
        const postsContainer = document.getElementById('postsContainer');
        const createResponse = document.getElementById('createResponse');

        // Create Post
        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const tags = document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const mediaUrl = document.getElementById('mediaUrl').value;

            const postData = {
                userId: "123456", // Hardcoded for testing
                title,
                content,
                tags,
                mediaUrls: mediaUrl ? [mediaUrl] : []
            };

            try {
                const res = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });

                if (res.ok) {
                    const data = await res.json();
                    createResponse.innerHTML = `<p class="success">Post created successfully! ID: ${data.id}</p>`;
                    form.reset();
                    fetchAllPosts();
                } else {
                    const error = await res.json();
                    createResponse.innerHTML = `<p class="error">Failed: ${error.message || res.statusText}</p>`;
                }
            } catch (err) {
                createResponse.innerHTML = `<p class="error">Error: ${err.message}</p>`;
            }
        });

        // Get All Posts
        getPostsBtn.addEventListener('click', fetchAllPosts);

        // Get Post by ID
        getPostByIdBtn.addEventListener('click', async () => {
            const postId = postIdSearch.value.trim();
            if (!postId) {
                postsContainer.innerHTML = `<p class="error">Please enter a post ID</p>`;
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/${postId}`);
                if (res.ok) {
                    const post = await res.json();
                    displayPosts([post]);
                } else {
                    const error = await res.json();
                    postsContainer.innerHTML = `<p class="error">Error: ${error.message || 'Post not found'}</p>`;
                }
            } catch (err) {
                postsContainer.innerHTML = `<p class="error">Error: ${err.message}</p>`;
            }
        });

        // Fetch all posts
        async function fetchAllPosts() {
            try {
                const res = await fetch(API_BASE_URL);
                if (res.ok) {
                    const posts = await res.json();
                    displayPosts(posts);
                } else {
                    const error = await res.json();
                    postsContainer.innerHTML = `<p class="error">Error: ${error.message || res.statusText}</p>`;
                }
            } catch (err) {
                postsContainer.innerHTML = `<p class="error">Error: ${err.message}</p>`;
            }
        }

        // Display posts with edit and delete buttons
        function displayPosts(posts) {
            if (posts.length === 0) {
                postsContainer.innerHTML = '<p>No posts found</p>';
                return;
            }

            postsContainer.innerHTML = posts.map(post => `
                <div class="post" id="post-${post.id}">
                    <div class="action-buttons">
                        <button class="edit-btn" data-id="${post.id}">Edit</button>
                        <button class="delete-btn" data-id="${post.id}">Delete</button>
                    </div>
                    <h3>${post.title}</h3>
                    <p><strong>ID:</strong> ${post.id}</p>
                    <p><strong>Author:</strong> ${post.userId}</p>
                    <p>${post.content}</p>
                    ${post.tags && post.tags.length > 0 ? 
                        `<p><strong>Tags:</strong> ${post.tags.join(', ')}</p>` : ''}
                    ${post.mediaUrls && post.mediaUrls.length > 0 ? 
                        `<p><strong>Media:</strong> ${post.mediaUrls.map(url => 
                            `<a href="${url}" target="_blank">${url}</a>`).join(', ')}</p>` : ''}
                    <p><small>Created at: ${new Date(post.createdAt).toLocaleString()}</small></p>
                    
                    <div class="edit-form" id="edit-form-${post.id}">
                        <h4>Edit Post</h4>
                        <form class="update-form" data-id="${post.id}">
                            <label>Title:</label>
                            <input type="text" name="title" value="${post.title}" required>
                            
                            <label>Content:</label>
                            <textarea name="content" required>${post.content}</textarea>
                            
                            <label>Tags (comma separated):</label>
                            <input type="text" name="tags" value="${post.tags ? post.tags.join(', ') : ''}">
                            
                            <label>Media URL (optional):</label>
                            <input type="text" name="mediaUrl" value="${post.mediaUrls && post.mediaUrls.length > 0 ? post.mediaUrls[0] : ''}">
                            
                            <input type="submit" value="Update Post">
                            <button type="button" class="cancel-edit" data-id="${post.id}">Cancel</button>
                        </form>
                    </div>
                </div>
            `).join('');

            // Add event listeners for edit buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const postId = e.target.getAttribute('data-id');
                    document.getElementById(`edit-form-${postId}`).style.display = 'block';
                });
            });

            // Add event listeners for cancel buttons
            document.querySelectorAll('.cancel-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const postId = e.target.getAttribute('data-id');
                    document.getElementById(`edit-form-${postId}`).style.display = 'none';
                });
            });

            // Add event listeners for update forms
            document.querySelectorAll('.update-form').forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const postId = e.target.getAttribute('data-id');
                    
                    const title = form.elements['title'].value;
                    const content = form.elements['content'].value;
                    const tags = form.elements['tags'].value.split(',').map(tag => tag.trim()).filter(tag => tag);
                    const mediaUrl = form.elements['mediaUrl'].value;

                    const postData = {
                        title,
                        content,
                        tags,
                        mediaUrls: mediaUrl ? [mediaUrl] : []
                    };

                    try {
                        const res = await fetch(`${API_BASE_URL}/${postId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(postData)
                        });

                        if (res.ok) {
                            fetchAllPosts();
                        } else {
                            const error = await res.json();
                            alert(`Update failed: ${error.message || res.statusText}`);
                        }
                    } catch (err) {
                        alert(`Error: ${err.message}`);
                    }
                });
            });

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    if (!confirm('Are you sure you want to delete this post?')) {
                        return;
                    }
                    
                    const postId = e.target.getAttribute('data-id');
                    
                    try {
                        const res = await fetch(`${API_BASE_URL}/${postId}`, {
                            method: 'DELETE'
                        });

                        if (res.ok) {
                            fetchAllPosts();
                        } else {
                            const error = await res.json();
                            alert(`Delete failed: ${error.message || res.statusText}`);
                        }
                    } catch (err) {
                        alert(`Error: ${err.message}`);
                    }
                });
            });
        }

        // Initial load of posts
        fetchAllPosts();
    </script>
</body>
</html>